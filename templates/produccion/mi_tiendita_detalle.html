{% extends 'produccion/base_produccion.html' %}
{% load static %}

{% block title %}{{ producto.nombre }} - Detalles{% endblock %}

{% block page_title %}Detalles del Producto{% endblock %}

{% block content %}
<div class="container">
    <div class="mb-3">
        <a href="{% url 'produccion:mi_tiendita' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Volver a la Tienda
        </a>
    </div>

    <div class="row">
        <!-- Columna de Imágenes -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <!-- Imagen Principal -->
                    {% if producto.imagen %}
                        <img src="{{ producto.imagen.url }}" class="img-fluid rounded mb-3 w-100" alt="{{ producto.nombre }}" style="max-height: 500px; object-fit: contain;" id="mainImage">
                    {% else %}
                        <div class="bg-light d-flex align-items-center justify-content-center rounded mb-3" style="height: 400px;">
                            <i class="bi bi-box-seam display-1 text-secondary"></i>
                        </div>
                    {% endif %}

                    <!-- Galería de Miniaturas -->
                    {% if imagenes_adicionales %}
                    <div class="d-flex flex-wrap gap-2 justify-content-center">
                        {% if producto.imagen %}
                        <img src="{{ producto.imagen.url }}" class="img-thumbnail thumbnail-active" style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;" onclick="changeImage(this.src)">
                        {% endif %}
                        {% for img in imagenes_adicionales %}
                        <img src="{{ img.imagen.url }}" class="img-thumbnail" style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;" onclick="changeImage(this.src)">
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Columna de Detalles -->
        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body p-4">
                    <h1 class="display-6 fw-bold mb-3">{{ producto.nombre }}</h1>
                    
                    <div class="mb-4">
                        <span class="h3 text-primary fw-bold">{{ mipyme.moneda_predeterminada }} {{ producto.precio_venta }}</span>
                        <span class="badge bg-success ms-2">Disponible</span>
                    </div>

                    <div class="mb-4">
                        <h5 class="text-muted mb-2">Descripción</h5>
                        <p class="lead" style="font-size: 1.1rem;">{{ producto.descripcion|default:"Sin descripción disponible."|linebreaks }}</p>
                    </div>

                    {% if producto.presentacion %}
                    <div class="mb-4">
                        <h6 class="text-muted">Presentación</h6>
                        <p>{{ producto.presentacion }}</p>
                    </div>
                    {% endif %}

                    {% if producto.peso or producto.tamano_largo %}
                    <div class="mb-4">
                        <h6 class="text-muted">Especificaciones</h6>
                        <ul class="list-unstyled">
                            {% if producto.peso %}<li><strong>Peso:</strong> {{ producto.peso }} kg</li>{% endif %}
                            {% if producto.tamano_largo %}<li><strong>Dimensiones:</strong> {{ producto.tamano_largo }}x{{ producto.tamano_ancho }}x{{ producto.tamano_alto }} cm</li>{% endif %}
                        </ul>
                    </div>
                    {% endif %}

                    <hr>

                    <!-- Gestión de Imágenes -->
                    <div class="card bg-light border-0">
                        <div class="card-body">
                            <h5 class="card-title mb-3"><i class="bi bi-images me-2"></i>Gestión de Imágenes</h5>
                            <form method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                
                                <!-- Actualizar Imagen Principal -->
                                <div class="mb-3">
                                    <label for="imagen_principal" class="form-label fw-bold">Actualizar Imagen Principal</label>
                                    <input type="file" class="form-control" id="imagen_principal" name="imagen_principal" accept="image/*">
                                </div>

                                <!-- Agregar Imágenes Adicionales -->
                                <div class="mb-3">
                                    <label for="imagenes_adicionales" class="form-label fw-bold">Agregar Imágenes Adicionales</label>
                                    <input type="file" class="form-control" id="imagenes_adicionales" name="imagenes_adicionales" multiple accept="image/*">
                                    <div class="form-text">Puedes seleccionar varios archivos (Máx 20 total).</div>
                                </div>

                                <!-- Eliminar Imágenes Existentes -->
                                {% if imagenes_adicionales %}
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Eliminar Imágenes Adicionales</label>
                                    <div class="row g-2">
                                        {% for img in imagenes_adicionales %}
                                        <div class="col-4 col-sm-3">
                                            <div class="card h-100">
                                                <img src="{{ img.imagen.url }}" class="card-img-top" style="height: 60px; object-fit: cover;" alt="Img {{ img.id }}">
                                                <div class="card-body p-1 text-center">
                                                    <div class="form-check d-inline-block">
                                                        <input class="form-check-input" type="checkbox" name="eliminar_imagen_ids" value="{{ img.id }}" id="del_img_{{ img.id }}">
                                                        <label class="form-check-label small text-danger" for="del_img_{{ img.id }}">
                                                            Borrar
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}

                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save me-2"></i>Guardar Cambios en Imágenes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function changeImage(src) {
        document.getElementById('mainImage').src = src;
        // Optional: Add active class logic here
    }
</script>
{% endblock %}
