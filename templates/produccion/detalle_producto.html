<!-- produccion/templates/produccion/detalle_producto.html -->
{% extends 'produccion/base_produccion.html' %}

{% block title %}Detalle de {{ producto.nombre }}{% endblock %}

{% block page_title %}Detalle de Producto: {{ producto.nombre }}{% endblock %}

{% block extra_buttons %}
<a href="{% url 'produccion:calculadora_lotes' producto.id %}" class="btn btn-info">
    <i class="bi bi-calculator me-1"></i> Calculadora de Lotes
</a>
{% endblock %}

{% block content %}
<!-- Fila para Resumen del Producto en formato de tabla -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">Resumen Financiero y de Inventario</h5>
            </div>
            <div class="card-body p-0"> <!-- Eliminamos el padding para que la tabla se ajuste perfecto -->
                <div class="table-responsive">
                    <table class="table table-bordered mb-0">
                        <tbody>
                            <!-- Sección Financiera -->
                            <tr>
                                <td class="w-25"><strong>Precio de Venta (PVP)</strong></td>
                                <td class="fs-5">${{ producto.precio_venta|floatformat:2 }}</td>
                            </tr>
                            {% if has_active_impuestos %}
                            <tr>
                                <td><strong>Precio con Impuestos</strong></td>
                                <td class="fs-5 fw-bold text-success">${{ producto.precio_con_impuestos|floatformat:2 }}</td>
                            </tr>
                            {% endif %}
                            <tr class="table-light">
                                <td><strong>Costo de Producción Total</strong></td>
                                <td class="fs-5">${{ producto.costo_de_produccion|floatformat:2 }}</td>
                            </tr>
                            <tr>
                                <!-- Usamos un poco de estilo para indentar y mostrar jerarquía -->
                                <td style="padding-left: 2.5rem;"><small>↳ Costo de Insumos</small></td>
                                <td><small>${{ producto.costo_insumos|floatformat:2 }} (incluye desperdicio)</small></td>
                            </tr>
                            <tr>
                                <td style="padding-left: 2.5rem;"><small>↳ Costo de Procesos</small></td>
                                <td><small>${{ producto.costo_procesos|floatformat:2 }} (mano de obra/máquina)</small></td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>Margen de Ganancia (Unitario)</strong></td>
                                <td class="fs-5 fw-bold">${{ producto.margen_de_ganancia|floatformat:2 }}</td>
                            </tr>

                            <!-- Separador Visual -->
                            <tr class="table-group-divider">
                                <td colspan="2"></td>
                            </tr>

                            <!-- Sección de Inventario y Descripción -->
                            <tr>
                                <td><strong>Sector</strong></td>
                                <td>
                                    {% if producto.mipyme.sector %}
                                        <span class="badge bg-info">{{ producto.mipyme.sector.nombre }}</span>
                                    {% else %}
                                        <em>No asignado</em>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Stock Actual</strong></td>
                                <td><strong>{{ producto.stock_actual }}</strong> unidades</td>
                            </tr>
                             <tr>
                                 <td><strong>Descripción</strong></td>
                                 <td>{{ producto.descripcion|default:"No especificada"|linebreaksbr }}</td>
                             </tr>
                             <tr>
                                 <td><strong>Peso</strong></td>
                                 <td>{{ producto.peso|default:"No especificado"|floatformat:2 }} kg</td>
                             </tr>
                             <tr>
                                 <td><strong>Dimensiones</strong></td>
                                 <td>
                                     {% if producto.tamano_largo or producto.tamano_ancho or producto.tamano_alto %}
                                         {% if producto.tamano_largo %}Largo: {{ producto.tamano_largo|floatformat:2 }} cm{% endif %}
                                         {% if producto.tamano_ancho %} x Ancho: {{ producto.tamano_ancho|floatformat:2 }} cm{% endif %}
                                         {% if producto.tamano_alto %} x Alto: {{ producto.tamano_alto|floatformat:2 }} cm{% endif %}
                                     {% else %}
                                         No especificadas
                                     {% endif %}
                                 </td>
                             </tr>
                             <tr>
                                 <td><strong>Presentación</strong></td>
                                 <td>{{ producto.presentacion|default:"No especificada" }}</td>
                             </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Fila para la Formulación (Insumos) -->
<div class="row mb-4">
    <!-- Columna de la Tabla de Insumos -->
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-archive-fill me-2"></i>Formulación de Insumos</h5></div>
            <div class="card-body">
                {% if formulacion_items %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Insumo</th>
                                    <th>Cantidad / Desperdicio</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in formulacion_items %}
                                <tr>
                                    <td>{{ item.insumo.nombre }}</td>
                                    <td>
                                        {{ item.cantidad|floatformat:2 }} {{ item.insumo.unidad.abreviatura }}
                                        <small class="d-block text-muted">({{ item.porcentaje_desperdicio|floatformat:2 }}% desperdicio)</small>
                                    </td>
                                    <td>
                                        <a href="{% url 'produccion:editar_formulacion_item' producto.id item.id %}" class="btn btn-sm btn-warning" title="Editar">
                                            <i class="bi bi-pencil-fill"></i>
                                        </a>
                                        <form method="post" action="{% url 'produccion:eliminar_formulacion_item' producto.id item.id %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-danger" title="Eliminar"
                                                    onclick="return confirm('¿Estás seguro de que quieres quitar este insumo?');">
                                                <i class="bi bi-trash-fill"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info">Aún no has añadido insumos a esta receta.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Columna del Formulario para Añadir Insumo -->
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Añadir Insumo</h5></div>
            <div class="card-body">
                <!-- NOTA: El name="submit_insumo" es clave para que la vista sepa qué formulario se envió -->
                <form method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="{{ form_insumo.insumo.id_for_label }}" class="form-label">Insumo</label>
                        {{ form_insumo.insumo }}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form_insumo.cantidad.id_for_label }}" class="form-label">Cantidad</label>
                        {{ form_insumo.cantidad }}
                    </div>
                    <!-- CAMPO NUEVO: Porcentaje de Desperdicio -->
                    {% if usar_margen_desperdicio_predeterminado %}
                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <strong>Margen de desperdicio automático:</strong> Se aplicará el margen configurado del {{ margen_desperdicio_predeterminado }}% a este insumo.
                    </div>
                    {% else %}
                    <div class="mb-3">
                        <label for="{{ form_insumo.porcentaje_desperdicio.id_for_label }}" class="form-label">% Desperdicio</label>
                        {{ form_insumo.porcentaje_desperdicio }}
                    </div>
                    {% endif %}
                    <button type="submit" name="submit_insumo" class="btn btn-success w-100">
                        <i class="bi bi-check-circle-fill me-1"></i> Guardar en Receta
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- ================================================================== -->
<!-- NUEVA FILA: Para la Ruta de Producción (Procesos) -->
<!-- ================================================================== -->
<div class="row">
    <!-- Columna de la Tabla de Procesos -->
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-gear-wide-connected me-2"></i>Ruta de Producción (Procesos)</h5></div>
            <div class="card-body">
                {% if pasos_produccion %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Proceso</th>
                                    <th>Tiempo Requerido</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for paso in pasos_produccion %}
                                <tr>
                                    <td>{{ paso.proceso.nombre }}</td>
                                    <td>{{ paso.tiempo_en_minutos }} minutos</td>
                                    <td>
                                        <a href="{% url 'produccion:editar_paso_produccion' producto.id paso.id %}" class="btn btn-sm btn-warning" title="Editar">
                                            <i class="bi bi-pencil-fill"></i>
                                        </a>
                                        <form method="post" action="{% url 'produccion:eliminar_paso_produccion' producto.id paso.id %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-danger" title="Eliminar"
                                                    onclick="return confirm('¿Estás seguro de que quieres quitar este proceso?');">
                                                <i class="bi bi-trash-fill"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info">Aún no has añadido procesos a la ruta de producción.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Columna del Formulario para Añadir Proceso -->
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Añadir Proceso</h5></div>
            <div class="card-body">
                  <!-- NOTA: El name="submit_proceso" es clave para que la vista sepa qué formulario se envió -->
                <form method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="{{ form_proceso.proceso.id_for_label }}" class="form-label">Proceso</label>
                        {{ form_proceso.proceso }}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form_proceso.tiempo_en_minutos.id_for_label }}" class="form-label">Tiempo (minutos)</label>
                        {{ form_proceso.tiempo_en_minutos }}
                    </div>
                    <button type="submit" name="submit_proceso" class="btn btn-success w-100">
                        <i class="bi bi-check-circle-fill me-1"></i> Guardar en Ruta
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ================================================================== -->
<!-- NUEVA FILA: Para los Impuestos -->
<!-- ================================================================== -->
<div class="row mb-4">
    <!-- Columna de la Lista de Impuestos -->
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-cash-coin me-2"></i>Impuestos Aplicados</h5></div>
            <div class="card-body">
                {% if impuestos_con_estado %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Impuesto</th>
                                    <th>Porcentaje</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in impuestos_con_estado %}
                                <tr>
                                    <td>{{ item.impuesto.nombre }}</td>
                                    <td>{{ item.impuesto.porcentaje }}%</td>
                                    <td>
                                        {% if item.impuesto.activo %}
                                            <span class="badge bg-success">Activo</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactivo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.aplicado %}
                                            <form method="post" style="display: inline;">
                                                {% csrf_token %}
                                                <input type="hidden" name="impuesto_id" value="{{ item.impuesto.id }}">
                                                <button type="submit" name="quitar_impuesto" class="btn btn-sm btn-danger" title="Quitar impuesto">
                                                    <i class="bi bi-dash-circle-fill"></i> Quitar
                                                </button>
                                            </form>
                                            {% if item.mensaje %}
                                                <div class="alert alert-warning mt-2 small">
                                                    <i class="bi bi-exclamation-triangle-fill me-1"></i>{{ item.mensaje }}
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <form method="post" style="display: inline;">
                                                {% csrf_token %}
                                                <input type="hidden" name="impuesto_id" value="{{ item.impuesto.id }}">
                                                <button type="submit" name="agregar_impuesto" class="btn btn-sm btn-success" title="Agregar impuesto">
                                                    <i class="bi bi-plus-circle-fill"></i> Agregar
                                                </button>
                                            </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info">No hay impuestos activos configurados para esta empresa.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Columna de Información Adicional -->
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Información sobre Impuestos</h5></div>
            <div class="card-body">
                <p class="mb-2">Los impuestos aplicados al producto se sumarán automáticamente al precio de venta.</p>
                <p class="mb-2"><strong>Nota:</strong> Solo se muestran los impuestos activos. Si un impuesto estaba aplicado pero ahora está inactivo, se mostrará una advertencia.</p>
                <p class="mb-0">Para gestionar los impuestos, ve a <a href="{% url 'produccion:gestion_impuestos' %}">Gestión de Impuestos</a>.</p>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="{% url 'produccion:lista_productos' %}" class="btn btn-secondary"><i class="bi bi-arrow-left-circle me-1"></i> Volver al Listado</a>
</div>
{% endblock %}