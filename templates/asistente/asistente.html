{% extends "base.html" %}

{% block title %}Asistente Virtual{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Asistente Virtual para Mipymes</h1>
    <div id="chat-container" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto;">
        {% for mensaje in mensajes %}
        <div class="message {% if mensaje.es_usuario %}user-message{% else %}assistant-message{% endif %}">
            <strong>{% if mensaje.es_usuario %}Tú:{% else %}Asistente:{% endif %}</strong> {{ mensaje.contenido|linebreaks }}
        </div>
        {% endfor %}
    </div>
    <form id="chat-form" method="post">
        {% csrf_token %}
        <div class="input-group mb-2">
            <select name="modelo" id="modelo-select" class="form-select">
                <option value="openai">OpenAI</option>
                <option value="gemini">Gemini</option>
                <option value="deepseek">DeepSeek</option>
            </select>
        </div>
        <div class="input-group">
            <input type="text" name="mensaje" id="mensaje-input" class="form-control" placeholder="Escribe tu mensaje aquí..." required>
            <button type="submit" class="btn btn-primary">Enviar</button>
        </div>
    </form>
</div>

<script>
document.getElementById('chat-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch('', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        const chatContainer = document.getElementById('chat-container');
        const userMessage = document.createElement('div');
        userMessage.className = 'message user-message';
        userMessage.innerHTML = '<strong>Tú:</strong> ' + formData.get('mensaje');
        chatContainer.appendChild(userMessage);

        const assistantMessage = document.createElement('div');
        assistantMessage.className = 'message assistant-message';
        assistantMessage.innerHTML = '<strong>Asistente:</strong> ' + data.respuesta.replace(/\n/g, '<br>');
        chatContainer.appendChild(assistantMessage);

        chatContainer.scrollTop = chatContainer.scrollHeight;
        document.getElementById('mensaje-input').value = '';
    });
});
</script>

<style>
.message {
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 5px;
}
.user-message {
    background-color: #e3f2fd;
    text-align: right;
}
.assistant-message {
    background-color: #f5f5f5;
}
</style>
{% endblock %}